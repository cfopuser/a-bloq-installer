<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://api.github.com; object-src 'none';">
    
    <title>מתקין A-Bloq</title>
    
    <!-- Google Fonts & Material Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" rel="stylesheet" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/styles.css">

    <!-- WebADB Library -->
    <script src="js/webadb.js"></script>
</head>
<body class="welcome-mode">

    <header>
        <div class="app-title" onclick="window.location.reload()">
            <span class="material-symbols-rounded">security</span>
            מתקין A-Bloq
        </div>
        <div class="stepper">
            <div class="step-dot active" id="dot-0"></div>
            <div class="step-dot" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
            <div class="step-dot" id="dot-4"></div>
        </div>
    </header>

    <div class="main-container">
        <!-- ... Content Panel ... -->
        <div class="content-panel">

            <!-- PAGE 0: Welcome -->
            <div id="page-main" class="page active" style="justify-content: center; align-items: center; text-align: center;">
                <div id="page-main-content">
                    <span class="material-symbols-rounded" style="font-size: 80px; color: var(--md-sys-color-primary); margin-bottom: 20px;">android</span>
                    <h2>ברוכים הבאים</h2>
                    <p style="color: var(--md-sys-color-outline); max-width: 400px; margin-bottom: 40px;">
                        כלי זה יסייע לכם להתקין ולהגדיר את A-Bloq על מכשיר האנדרואיד שלכם בקלות ובמהירות.
                    </p>
                    <button class="btn" onclick="navigateTo('page-adb', 1)">
                        התחל תהליך
                        <span class="material-symbols-rounded">arrow_back</span>
                    </button>
                </div>
                <div id="compatibility-notice">
                    <span class="material-symbols-rounded" style="font-size: 80px; color: var(--md-sys-color-error); margin-bottom: 20px;">browser_updated</span>
                    <h2>דפדפן לא נתמך</h2>
                    <p style="color: var(--md-sys-color-outline); max-width: 400px; margin-bottom: 40px;">
                        התקנה זו דורשת תמיכה ב-WebUSB. אנא השתמש בדפדפן עדכני כגון Google Chrome, Microsoft Edge, או Opera.
                    </p>
                </div>
            </div>

            <!-- PAGE 1: ADB -->
            <div id="page-adb" class="page">
                <h2>חיבור למחשב</h2>
                <div class="info-card">
                    <span class="material-symbols-rounded">usb</span>
                    <div>יש להפעיל "אפשרויות מפתחים" ו"ניפוי באגים ב-USB" כדי לאפשר לתוכנה לתקשר עם המכשיר.</div>
                </div>

                <div style="flex-grow: 1;">
                    <div class="list-item"><div class="icon">1</div> חברו את המכשיר למחשב באמצעות כבל USB</div>
                    <div class="list-item"><div class="icon">2</div> הכנסו להגדרות -> מידע על המכשיר</div>
                    <div class="list-item"><div class="icon">3</div> לחצו 7 פעמים על "מספר Build"</div>
                    <div class="list-item"><div class="icon">4</div> חזרו למערכת -> אפשרויות מפתחים</div>
                    <div class="list-item"><div class="icon">5</div> הפעילו את "ניפוי באגים ב-USB"</div>
                    <div class="list-item" style="color: var(--md-sys-color-primary);">
                        <div class="icon" style="background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary);">!</div>
                        בחלון שיופיע במכשיר, סמנו "אפשר תמיד ממחשב זה" ואשרו.
                    </div>
                </div>

                <div class="action-area">
                    <div id="adb-status" class="status-badge">
                        <span class="material-symbols-rounded">link_off</span> לא מחובר
                    </div>
                    <div>
                        <button id="btn-connect" class="btn" onclick="connectAdb()">חבר מכשיר</button>
                        <button id="btn-next-adb" class="btn" onclick="navigateTo('page-accounts', 2)" disabled style="display:none;">
                            הבא <span class="material-symbols-rounded">arrow_back</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PAGE 2: Accounts -->
            <div id="page-accounts" class="page">
                <h2>בדיקת חשבונות</h2>
                <div class="info-card" style="background: rgba(255, 180, 171, 0.1); color: #ffb4ab;">
                    <span class="material-symbols-rounded" style="color: #ffb4ab;">warning</span>
                    <div>חובה להסיר את כל חשבונות Google/Samsung מהמכשיר זמנית. ניתן להחזיר אותם לאחר ההתקנה.</div>
                </div>

                <div class="list-item"><div class="icon">1</div> הכנסו להגדרות -> חשבונות וגיבוי -> נהל חשבונות</div>
                <div class="list-item"><div class="icon">2</div> בחרו כל חשבון והקישו "הסר חשבון"</div>
                
                <!-- Account List Container -->
                <div id="account-list"></div>
                
                <!-- Fill space -->
                <div style="flex-grow: 1;"></div>
                
                <!-- Hidden Warning Box for Bypass -->
                <div id="bypass-warning" class="warning-box" style="margin-bottom: 20px;">
                    <strong style="display:block; margin-bottom:5px;">⚠️ מצב ניסיוני (Beta)</strong>
                        פעולה זו תנסה להשבית זמנית את החשבונות במכשיר במקום שתצטרך למחוק אותם. <br>
                        זה עלול לגרום לקריסות זמניות. החשבונות יופעלו מחדש אוטומטית בסיום ההתקנה.                    <br><br>
                    <button class="btn btn-tonal" style="font-size: 0.8rem; height: 36px;" onclick="runAccountBypass()">
                        אני מבין, בצע השבתה זמנית
                    </button>
                </div>

                <div class="action-area">
                    <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                        <div id="account-status" class="status-badge">
                            <span class="material-symbols-rounded">pending</span> ממתין לבדיקה
                        </div>
                        
                        <button id="btn-bypass-trigger" class="btn-calm" onclick="toggleBypassWarning()" style="display: none;" title="נסה הסרה אוטומטית (Beta)">
                            <span class="material-symbols-rounded">auto_fix</span>
                        התקנה ללא הסרה (Beta)
                        </button>
                    </div>

                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-tonal" onclick="checkAccounts()">
                            <span class="material-symbols-rounded">refresh</span> בדוק שוב
                        </button>
                        <button id="btn-next-acc" class="btn" onclick="navigateTo('page-update', 3)" disabled>
                            הבא <span class="material-symbols-rounded">arrow_back</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- PAGE 3: Update -->
            <div id="page-update" class="page">
                <h2>עדכון גרסה</h2>
                <div class="info-card">
                    <span class="material-symbols-rounded">cloud_download</span>
                    <div id="update-info-text">יוצר קשר עם שרתי GitHub...</div>
                </div>

                <div style="flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <h3 id="dl-status-text" style="font-weight: 300; margin: 0;"></h3>
                    <div class="progress-wrapper" id="dl-progress-wrapper">
                        <div class="progress-fill" id="dl-progress-bar"></div>
                    </div>
                </div>

                <div class="action-area">
                    <button class="btn btn-tonal" onclick="navigateTo('page-install', 4)">דלג והשתמש בגרסה קיימת</button>
                    <button id="btn-download" class="btn" onclick="startDownload()" disabled>
                        <span class="material-symbols-rounded">download</span> הורד ועדכן
                    </button>
                </div>
            </div>

            <!-- PAGE 4: Install -->
            <div id="page-install" class="page">
                <h2>התקנה והגדרות</h2>
                <div class="terminal" id="install-log"></div>

                <div class="progress-wrapper" id="install-progress-wrapper" style="display: block;">
                    <div class="progress-fill" id="install-progress-bar"></div>
                </div>

                <div class="action-area">
                    <div class="status-badge">
                        <span class="material-symbols-rounded">terminal</span> Console
                    </div>
                    <button id="btn-install-start" class="btn" onclick="runInstallation()">
                        <span class="material-symbols-rounded">play_arrow</span> התחל התקנה
                    </button>
                </div>
            </div>

        </div>

        <!-- RIGHT PANEL (PHONE) -->
        <div class="phone-panel">
            <div class="phone-frame">
                <video id="guide-video" src="Videos/enable-adb.mp4" loop muted playsinline></video>
                
                <!-- NEW: Success Screen (Hidden by default) -->
                <div id="phone-success-message">
                    <span class="material-symbols-rounded icon">verified</span>
                    <div class="text">
                        תודה שבחרתם ב<br>
                        <span class="brand">A-Bloq</span>
                    </div>
                </div>
            </div>
            
            <div class="phone-controls">
                <button class="btn btn-tonal" onclick="toggleVideo()" style="border-radius: 50%; width: 50px; height: 50px; padding: 0;">
                    <span class="material-symbols-rounded" id="video-icon">play_arrow</span>
                </button>
            </div>
            <p style="color: var(--md-sys-color-outline); font-size: 0.9rem;">סרטון הדרכה (ייתכנו שינויים בין דגמים)</p>
        </div>

    </div>

    <!-- Snackbar for Notifications -->
    <div id="snackbar">הודעה כללית</div>

    <!-- SCRIPTS -->
    <script src="js/app.js"></script>
    <script src="js/utils.js"></script>
</body>
</html>